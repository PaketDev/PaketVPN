#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
ROOT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
BASE_DIR="$ROOT_DIR/project"
COMPOSE_FILE="$BASE_DIR/docker-compose.yml"
SERVICE_NAME="paketvpn-bot"
DEFAULT_BRANCH="${GIT_BRANCH:-main}"

if [[ ! -f "$COMPOSE_FILE" ]]; then
  echo "docker-compose file not found: $COMPOSE_FILE"
  exit 1
fi

if docker compose version >/dev/null 2>&1; then
  COMPOSE=(docker compose -f "$COMPOSE_FILE" --project-directory "$BASE_DIR")
elif command -v docker-compose >/dev/null 2>&1; then
  COMPOSE=(docker-compose -f "$COMPOSE_FILE")
else
  echo "docker compose is not installed"
  exit 1
fi

run_action() {
  local action="${1:-}"
  shift || true
  case "$action" in
    start)
      "${COMPOSE[@]}" up -d "$SERVICE_NAME"
      ;;
    stop)
      "${COMPOSE[@]}" stop "$SERVICE_NAME"
      ;;
    restart)
      "${COMPOSE[@]}" restart "$SERVICE_NAME"
      ;;
    status)
      "${COMPOSE[@]}" ps "$SERVICE_NAME"
      ;;
    logs)
      "${COMPOSE[@]}" logs -f --tail=200 "$SERVICE_NAME"
      ;;
    build)
      "${COMPOSE[@]}" build "$SERVICE_NAME"
      ;;
    rebuild)
      "${COMPOSE[@]}" up -d --build "$SERVICE_NAME"
      ;;
    down)
      "${COMPOSE[@]}" down
      ;;
    shell)
      "${COMPOSE[@]}" exec "$SERVICE_NAME" sh
      ;;
    ship)
      local branch="${1:-$DEFAULT_BRANCH}"
      local message="${2:-chore: deploy $(date -u '+%Y-%m-%d %H:%M:%SZ')}"

      if ! git -C "$ROOT_DIR" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "Current directory is not a git repository: $ROOT_DIR"
        return 1
      fi

      if ! git -C "$ROOT_DIR" remote get-url origin >/dev/null 2>&1; then
        echo "Git remote 'origin' is not configured"
        return 1
      fi

      git -C "$ROOT_DIR" add -A
      if git -C "$ROOT_DIR" diff --cached --quiet; then
        echo "No changes to commit."
        return 0
      fi

      git -C "$ROOT_DIR" commit -m "$message"
      git -C "$ROOT_DIR" push origin "$branch"
      ;;
    *)
      return 1
      ;;
  esac
}

if [[ $# -gt 0 ]]; then
  if ! run_action "$@"; then
    echo "Usage: bot {start|stop|restart|status|logs|build|rebuild|down|shell|ship [branch] [message]}"
    exit 1
  fi
  exit 0
fi

while true; do
  cat <<'MENU'

Bot Control Panel
1) Start
2) Stop
3) Restart
4) Status
5) Logs (tail)
6) Build
7) Rebuild and start
8) Down
9) Shell
10) Ship to GitHub
0) Exit
MENU
  read -r -p "Select: " choice
  case "$choice" in
    1) run_action start ;;
    2) run_action stop ;;
    3) run_action restart ;;
    4) run_action status ;;
    5) run_action logs ;;
    6) run_action build ;;
    7) run_action rebuild ;;
    8) run_action down ;;
    9) run_action shell ;;
    10)
      read -r -p "Branch [$DEFAULT_BRANCH]: " branch
      branch="${branch:-$DEFAULT_BRANCH}"
      read -r -p "Commit message [auto]: " message
      if [[ -n "$message" ]]; then
        run_action ship "$branch" "$message"
      else
        run_action ship "$branch"
      fi
      ;;
    0) exit 0 ;;
    *) echo "Unknown option" ;;
  esac
done
